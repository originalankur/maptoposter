<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapToPoster - Create Beautiful City Posters</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-glass: rgba(255, 255, 255, 0.7);
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            
            --border: rgba(148, 163, 184, 0.2);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-glass: rgba(30, 41, 59, 0.8);
            
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            
            --border: rgba(148, 163, 184, 0.1);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background decoration */
        .bg-decoration {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: float 20s ease-in-out infinite;
        }

        .bg-blob-1 {
            width: 600px;
            height: 600px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            top: -200px;
            right: -200px;
            animation-delay: 0s;
        }

        .bg-blob-2 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            bottom: -100px;
            left: -100px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* Layout */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Language Selector */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .lang-btn:hover {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
        }

        .lang-flag {
            font-size: 1.25rem;
        }

        .lang-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 0.5rem;
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            z-index: 1000;
        }

        .lang-selector:hover .lang-dropdown,
        .lang-dropdown:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        .lang-option:hover {
            background: var(--bg-tertiary);
        }

        .lang-option.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 44px;
            height: 44px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            box-shadow: var(--shadow-md);
            transform: rotate(15deg);
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Search */
        .search-wrapper {
            position: relative;
        }

        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3.5rem;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            color: var(--text-tertiary);
            font-size: 1.125rem;
            transition: var(--transition);
        }

        .search-input:focus ~ .search-icon {
            color: var(--primary);
        }

        .search-loader {
            position: absolute;
            right: 1rem;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .search-loader.active {
            opacity: 1;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-height: 320px;
            overflow-y: auto;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
        }

        .search-results.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .search-result-item {
            padding: 1rem 1.25rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-item.focused {
            background: var(--bg-tertiary);
            outline: 2px solid var(--primary);
        }

        .search-result-main {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .search-result-sub {
            font-size: 0.8125rem;
            color: var(--text-tertiary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Selected Location */
        .selected-location {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            border-radius: var(--radius-lg);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .selected-location.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selected-location-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .selected-location-header i {
            color: var(--primary);
        }

        .selected-location h4 {
            font-size: 1rem;
            font-weight: 700;
        }

        .selected-location p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 0.9375rem;
            font-family: inherit;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .form-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .form-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .form-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .form-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .form-slider::-moz-range-track {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            height: 8px;
        }

        .slider-value {
            min-width: 60px;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-group:hover {
            background: var(--bg-tertiary);
        }

        .toggle-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .toggle-label {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .toggle-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--border);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        /* Theme Grid */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 0.75rem;
            max-height: 280px;
            overflow-y: auto;
            padding: 0.25rem;
        }

        .theme-item {
            position: relative;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .theme-item:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .theme-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .theme-item.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
        }

        .theme-preview {
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            border: 1px solid var(--border);
        }

        .theme-name {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Generate Button */
        .generate-btn {
            width: 100%;
            padding: 1.125rem 2rem;
            font-size: 1.0625rem;
            font-weight: 700;
            font-family: inherit;
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .generate-btn:hover:not(:disabled)::before {
            opacity: 1;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn span,
        .generate-btn i {
            position: relative;
            z-index: 1;
        }

        .generate-btn + .card,
        .generate-btn + .progress-card + .card,
        .generate-btn + .progress-card + .result-card + .card {
            margin-top: 1.5rem;
        }

        /* Progress Section */
        .progress-card {
            display: none;
        }

        .progress-card.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .progress-bar-wrapper {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            height: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .progress-steps {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        .progress-step {
            text-align: center;
            padding: 0.75rem 0.25rem;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            transition: var(--transition);
        }

        .progress-step i {
            font-size: 1.25rem;
            margin-bottom: 0.375rem;
            display: block;
            color: var(--text-tertiary);
            transition: var(--transition);
        }

        .progress-step span {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .progress-step.active {
            background: rgba(99, 102, 241, 0.1);
        }

        .progress-step.active i {
            color: var(--primary);
            animation: pulse 1s ease-in-out infinite;
        }

        .progress-step.completed {
            background: rgba(16, 185, 129, 0.1);
        }

        .progress-step.completed i {
            color: var(--success);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .progress-message {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Result Section */
        .result-card {
            display: none;
        }

        .result-card.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-success {
            text-align: center;
            padding: 2rem 1rem;
        }

        .result-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .result-success h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .result-success p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--success), var(--accent));
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .result-error {
            text-align: center;
            padding: 2rem 1rem;
        }

        .result-error .result-icon {
            background: linear-gradient(135deg, var(--error), var(--warning));
        }

        /* Preview Panel */
        .preview-panel {
            position: sticky;
            top: 1.5rem;
        }

        .preview-container {
            aspect-ratio: 3/4;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
        }

        .preview-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }

        .preview-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .preview-placeholder p {
            font-size: 0.9375rem;
        }

        .preview-poster {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1.25rem;
        }

        .preview-poster.active {
            display: flex;
        }

        .preview-gradient-top,
        .preview-gradient-bottom {
            position: absolute;
            left: 0;
            right: 0;
            height: 30%;
            pointer-events: none;
        }

        .preview-gradient-top {
            top: 0;
        }

        .preview-gradient-bottom {
            bottom: 0;
        }

        .preview-text {
            position: relative;
            z-index: 10;
            text-align: center;
        }

        .preview-city {
            font-size: 1rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            margin-bottom: 0.375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-country {
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .preview-coords {
            font-size: 0.625rem;
            opacity: 0.6;
        }

        /* Gallery */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            max-height: 450px;
            overflow-y: auto;
        }

        .gallery-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-preview {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            background: var(--bg-tertiary);
            display: block;
        }

        .gallery-preview-pdf {
            width: 100%;
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }

        .gallery-preview-pdf i {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #ef4444;
        }

        .gallery-preview-pdf span {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .gallery-info {
            padding: 0.75rem;
        }

        .gallery-name {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gallery-theme {
            font-size: 0.6875rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gallery-theme i {
            color: var(--primary);
            font-size: 0.625rem;
        }

        .gallery-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }

        .gallery-format {
            padding: 0.125rem 0.375rem;
            background: var(--primary);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 0.625rem;
        }

        .gallery-download {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.75rem;
            transition: var(--transition);
        }

        .gallery-download:hover {
            filter: brightness(1.1);
        }

        .gallery-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: var(--text-tertiary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .progress-steps {
                grid-template-columns: repeat(3, 1fr);
            }

            .header-actions {
                gap: 0.5rem;
            }

            .lang-btn span {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="bg-blob bg-blob-1"></div>
        <div class="bg-blob bg-blob-2"></div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-map-location-dot"></i>
                </div>
                <span class="logo-text">MapToPoster</span>
            </div>
            
            <div class="header-actions">
                <!-- Language Selector -->
                <div class="lang-selector">
                    <button class="lang-btn" id="langBtn" aria-haspopup="listbox" aria-expanded="false" aria-label="Select language">
                        <span class="lang-flag" id="currentFlag">üá©üá™</span>
                        <span id="currentLang">Deutsch</span>
                        <i class="fas fa-chevron-down" style="font-size: 0.75rem;"></i>
                    </button>
                    <div class="lang-dropdown" id="langDropdown" role="listbox">
                        <div class="lang-option active" data-lang="de" data-flag="üá©üá™" role="option">
                            <span class="lang-flag">üá©üá™</span>
                            <span>Deutsch</span>
                        </div>
                        <div class="lang-option" data-lang="en" data-flag="üá¨üáß" role="option">
                            <span class="lang-flag">üá¨üáß</span>
                            <span>English</span>
                        </div>
                        <div class="lang-option" data-lang="fr" data-flag="üá´üá∑" role="option">
                            <span class="lang-flag">üá´üá∑</span>
                            <span>Fran√ßais</span>
                        </div>
                        <div class="lang-option" data-lang="es" data-flag="üá™üá∏" role="option">
                            <span class="lang-flag">üá™üá∏</span>
                            <span>Espa√±ol</span>
                        </div>
                        <div class="lang-option" data-lang="it" data-flag="üáÆüáπ" role="option">
                            <span class="lang-flag">üáÆüáπ</span>
                            <span>Italiano</span>
                        </div>
                        <div class="lang-option" data-lang="pt" data-flag="üáµüáπ" role="option">
                            <span class="lang-flag">üáµüáπ</span>
                            <span>Portugu√™s</span>
                        </div>
                        <div class="lang-option" data-lang="nl" data-flag="üá≥üá±" role="option">
                            <span class="lang-flag">üá≥üá±</span>
                            <span>Nederlands</span>
                        </div>
                        <div class="lang-option" data-lang="pl" data-flag="üáµüá±" role="option">
                            <span class="lang-flag">üáµüá±</span>
                            <span>Polski</span>
                        </div>
                        <div class="lang-option" data-lang="ja" data-flag="üáØüáµ" role="option">
                            <span class="lang-flag">üáØüáµ</span>
                            <span>Êó•Êú¨Ë™û</span>
                        </div>
                        <div class="lang-option" data-lang="zh" data-flag="üá®üá≥" role="option">
                            <span class="lang-flag">üá®üá≥</span>
                            <span>‰∏≠Êñá</span>
                        </div>
                        <div class="lang-option" data-lang="ko" data-flag="üá∞üá∑" role="option">
                            <span class="lang-flag">üá∞üá∑</span>
                            <span>ÌïúÍµ≠Ïñ¥</span>
                        </div>
                        <div class="lang-option" data-lang="ru" data-flag="üá∑üá∫" role="option">
                            <span class="lang-flag">üá∑üá∫</span>
                            <span>–†—É—Å—Å–∫–∏–π</span>
                        </div>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <button class="theme-toggle" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-grid">
            <div class="form-section">
                <!-- Search Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h2 class="card-title" data-i18n="search_title">Adresse suchen</h2>
                    </div>
                    
                    <div class="search-wrapper">
                        <div class="search-input-container">
                            <input type="text" class="search-input" id="searchInput" 
                                   data-i18n-placeholder="search_placeholder" 
                                placeholder="Stadt, Adresse oder Ort eingeben..." autocomplete="off"
                                role="combobox" aria-autocomplete="list" aria-expanded="false" aria-controls="searchResults">
                            <i class="fas fa-location-dot search-icon"></i>
                            <div class="search-loader" id="searchLoader"></div>
                        </div>
                        <div class="search-results" id="searchResults" role="listbox"></div>
                    </div>

                    <div class="selected-location" id="selectedLocation">
                        <div class="selected-location-header">
                            <i class="fas fa-check-circle"></i>
                            <h4 id="selectedCity">-</h4>
                        </div>
                        <p id="selectedAddress">-</p>
                        <p id="selectedCoords" style="font-size: 0.75rem; margin-top: 0.25rem;">-</p>
                    </div>
                </div>

                <!-- Settings Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-sliders"></i>
                        </div>
                        <h2 class="card-title" data-i18n="settings_title">Einstellungen</h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" data-i18n="city_label">Stadtname</label>
                            <input type="text" class="form-input" id="cityName" data-i18n-placeholder="city_placeholder" placeholder="z.B. Berlin">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="country_label">Land</label>
                            <input type="text" class="form-input" id="countryName" data-i18n-placeholder="country_placeholder" placeholder="z.B. Deutschland">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" data-i18n="radius_label">Kartenradius</label>
                            <div class="slider-container">
                                <input type="range" class="form-slider" id="distance" 
                                       min="1000" max="50000" value="10000" step="1000">
                                <div class="slider-value" id="distanceValue">10 km</div>
                            </div>
                            <div class="slider-labels">
                                <span>1 km</span>
                                <span>25 km</span>
                                <span>50 km</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="size_label">Postergr√∂√üe</label>
                            <select class="form-select" id="posterSize">
                                {% for size in sizes %}
                                <option value="{{ size }}" {% if size == 'Portrait' %}selected{% endif %}>{{ size }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" data-i18n="format_label">Ausgabeformat</label>
                            <select class="form-select" id="outputFormat">
                                <option value="png" data-i18n="format_png">PNG (Hochaufl√∂send, 300 DPI)</option>
                                <option value="svg" data-i18n="format_svg">SVG (Vektorgrafik)</option>
                                <option value="pdf" data-i18n="format_pdf">PDF (Druckfertig)</option>
                            </select>
                        </div>
                    </div>

                    <div class="toggle-group" id="buildingsToggle" role="switch" tabindex="0" aria-pressed="true" aria-checked="true">
                        <div class="toggle-info">
                            <div class="toggle-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <div class="toggle-label" data-i18n="buildings_label">Geb√§ude anzeigen</div>
                                <div class="toggle-desc" data-i18n="buildings_desc">Geb√§udeumrisse auf der Karte</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="includeBuildings" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Theme Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <h2 class="card-title" data-i18n="theme_title">Design-Theme</h2>
                    </div>
                    
                    <div class="theme-grid" id="themeGrid">
                        {% for theme in themes %}
                        <div class="theme-item {% if theme.id == 'feature_based' %}selected{% endif %}" 
                             data-theme="{{ theme.id }}" 
                             data-bg="{{ theme.bg }}" 
                             data-text="{{ theme.text }}"
                             title="{{ theme.description }}">
                            <div class="theme-preview" style="background: {{ theme.bg }}; border-color: {{ theme.text }};"></div>
                            <div class="theme-name">{{ theme.name }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Generate Button -->
                <button class="generate-btn" id="generateBtn" disabled>
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span data-i18n="generate_btn">Poster erstellen</span>
                </button>

                <!-- Progress Card -->
                <div class="card progress-card" id="progressCard">
                    <div class="card-header">
                        <div class="card-icon" style="animation: pulse 1s ease-in-out infinite;">
                            <i class="fas fa-cog fa-spin"></i>
                        </div>
                        <h2 class="card-title" data-i18n="progress_title">Wird erstellt...</h2>
                    </div>

                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>

                    <div class="progress-steps">
                        <div class="progress-step" data-step="fetch_streets">
                            <i class="fas fa-road"></i>
                            <span data-i18n="step_streets">Stra√üen</span>
                        </div>
                        <div class="progress-step" data-step="fetch_water">
                            <i class="fas fa-water"></i>
                            <span data-i18n="step_water">Gew√§sser</span>
                        </div>
                        <div class="progress-step" data-step="fetch_parks">
                            <i class="fas fa-tree"></i>
                            <span data-i18n="step_parks">Parks</span>
                        </div>
                        <div class="progress-step" data-step="fetch_buildings">
                            <i class="fas fa-building"></i>
                            <span data-i18n="step_buildings">Geb√§ude</span>
                        </div>
                        <div class="progress-step" data-step="render">
                            <i class="fas fa-paint-brush"></i>
                            <span data-i18n="step_render">Rendern</span>
                        </div>
                        <div class="progress-step" data-step="save">
                            <i class="fas fa-download"></i>
                            <span data-i18n="step_save">Speichern</span>
                        </div>
                    </div>

                    <p class="progress-message" id="progressMessage" data-i18n="progress_starting">Starte...</p>
                </div>

                <!-- Result Card -->
                <div class="card result-card" id="resultCard">
                    <div class="result-success" id="resultSuccess">
                        <div class="result-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3 data-i18n="result_success">Poster erfolgreich erstellt!</h3>
                        <p id="resultFilename">-</p>
                        <a href="#" class="download-btn" id="downloadBtn">
                            <i class="fas fa-download"></i>
                            <span data-i18n="download_btn">Herunterladen</span>
                        </a>
                    </div>
                    <div class="result-error" id="resultError" style="display: none;">
                        <div class="result-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <h3 data-i18n="result_error">Fehler aufgetreten</h3>
                        <p id="errorMessage">-</p>
                    </div>
                </div>

                <!-- Gallery Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <h2 class="card-title" data-i18n="gallery_title">Beispiel-Poster</h2>
                    </div>
                    
                    <div class="gallery-grid" id="galleryGrid">
                        <div class="gallery-empty" data-i18n="gallery_loading">Lade Poster...</div>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="preview-panel">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h2 class="card-title" data-i18n="preview_title">Vorschau</h2>
                    </div>
                    
                    <div class="preview-container" id="previewContainer">
                        <div class="preview-placeholder" id="previewPlaceholder">
                            <i class="fas fa-map"></i>
                            <p data-i18n="preview_placeholder">W√§hle eine Adresse</p>
                        </div>
                        <div class="preview-poster" id="previewPoster">
                            <div class="preview-gradient-top"></div>
                            <div class="preview-gradient-bottom"></div>
                            <div class="preview-text">
                                <div class="preview-city" id="previewCity">B E R L I N</div>
                                <div class="preview-country" id="previewCountry">DEUTSCHLAND</div>
                                <div class="preview-coords" id="previewCoords">52.5200¬∞ N / 13.4050¬∞ E</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== i18n Translations ====================
        const translations = {
            de: {
                search_title: 'Adresse suchen',
                search_placeholder: 'Stadt, Adresse oder Ort eingeben...',
                settings_title: 'Einstellungen',
                city_label: 'Stadtname',
                city_placeholder: 'z.B. Berlin',
                country_label: 'Land',
                country_placeholder: 'z.B. Deutschland',
                radius_label: 'Kartenradius',
                size_label: 'Postergr√∂√üe',
                format_label: 'Ausgabeformat',
                format_png: 'PNG (Hochaufl√∂send, 300 DPI)',
                format_svg: 'SVG (Vektorgrafik)',
                format_pdf: 'PDF (Druckfertig)',
                buildings_label: 'Geb√§ude anzeigen',
                buildings_desc: 'Geb√§udeumrisse auf der Karte',
                theme_title: 'Design-Theme',
                generate_btn: 'Poster erstellen',
                progress_title: 'Wird erstellt...',
                step_streets: 'Stra√üen',
                step_water: 'Gew√§sser',
                step_parks: 'Parks',
                step_buildings: 'Geb√§ude',
                step_render: 'Rendern',
                step_save: 'Speichern',
                progress_starting: 'Starte...',
                result_success: 'Poster erfolgreich erstellt!',
                result_error: 'Fehler aufgetreten',
                download_btn: 'Herunterladen',
                gallery_title: 'Beispiel-Poster',
                gallery_loading: 'Lade Beispiele...',
                gallery_empty: 'Keine Beispiele verf√ºgbar',
                preview_title: 'Vorschau',
                preview_placeholder: 'W√§hle eine Adresse'
            },
            en: {
                search_title: 'Search Address',
                search_placeholder: 'Enter city, address or place...',
                settings_title: 'Settings',
                city_label: 'City Name',
                city_placeholder: 'e.g. London',
                country_label: 'Country',
                country_placeholder: 'e.g. United Kingdom',
                radius_label: 'Map Radius',
                size_label: 'Poster Size',
                format_label: 'Output Format',
                format_png: 'PNG (High Resolution, 300 DPI)',
                format_svg: 'SVG (Vector Graphics)',
                format_pdf: 'PDF (Print Ready)',
                buildings_label: 'Show Buildings',
                buildings_desc: 'Building outlines on the map',
                theme_title: 'Design Theme',
                generate_btn: 'Create Poster',
                progress_title: 'Creating...',
                step_streets: 'Streets',
                step_water: 'Water',
                step_parks: 'Parks',
                step_buildings: 'Buildings',
                step_render: 'Render',
                step_save: 'Save',
                progress_starting: 'Starting...',
                result_success: 'Poster created successfully!',
                result_error: 'Error occurred',
                download_btn: 'Download',
                gallery_title: 'Example Posters',
                gallery_loading: 'Loading examples...',
                gallery_empty: 'No examples available',
                preview_title: 'Preview',
                preview_placeholder: 'Select an address'
            },
            fr: {
                search_title: 'Rechercher une adresse',
                search_placeholder: 'Entrez ville, adresse ou lieu...',
                settings_title: 'Param√®tres',
                city_label: 'Nom de la ville',
                city_placeholder: 'ex. Paris',
                country_label: 'Pays',
                country_placeholder: 'ex. France',
                radius_label: 'Rayon de la carte',
                size_label: 'Taille du poster',
                format_label: 'Format de sortie',
                format_png: 'PNG (Haute r√©solution, 300 DPI)',
                format_svg: 'SVG (Graphique vectoriel)',
                format_pdf: 'PDF (Pr√™t √† imprimer)',
                buildings_label: 'Afficher les b√¢timents',
                buildings_desc: 'Contours des b√¢timents sur la carte',
                theme_title: 'Th√®me de design',
                generate_btn: 'Cr√©er le poster',
                progress_title: 'Cr√©ation en cours...',
                step_streets: 'Rues',
                step_water: 'Eau',
                step_parks: 'Parcs',
                step_buildings: 'B√¢timents',
                step_render: 'Rendu',
                step_save: 'Sauver',
                progress_starting: 'D√©marrage...',
                result_success: 'Poster cr√©√© avec succ√®s!',
                result_error: 'Une erreur est survenue',
                download_btn: 'T√©l√©charger',
                gallery_title: 'Posters cr√©√©s',
                gallery_loading: 'Chargement des posters...',
                gallery_empty: 'Aucun poster cr√©√©',
                preview_title: 'Aper√ßu',
                preview_placeholder: 'S√©lectionnez une adresse'
            },
            es: {
                search_title: 'Buscar direcci√≥n',
                search_placeholder: 'Ingresa ciudad, direcci√≥n o lugar...',
                settings_title: 'Configuraci√≥n',
                city_label: 'Nombre de la ciudad',
                city_placeholder: 'ej. Madrid',
                country_label: 'Pa√≠s',
                country_placeholder: 'ej. Espa√±a',
                radius_label: 'Radio del mapa',
                size_label: 'Tama√±o del p√≥ster',
                format_label: 'Formato de salida',
                format_png: 'PNG (Alta resoluci√≥n, 300 DPI)',
                format_svg: 'SVG (Gr√°fico vectorial)',
                format_pdf: 'PDF (Listo para imprimir)',
                buildings_label: 'Mostrar edificios',
                buildings_desc: 'Contornos de edificios en el mapa',
                theme_title: 'Tema de dise√±o',
                generate_btn: 'Crear p√≥ster',
                progress_title: 'Creando...',
                step_streets: 'Calles',
                step_water: 'Agua',
                step_parks: 'Parques',
                step_buildings: 'Edificios',
                step_render: 'Renderizar',
                step_save: 'Guardar',
                progress_starting: 'Iniciando...',
                result_success: '¬°P√≥ster creado con √©xito!',
                result_error: 'Ocurri√≥ un error',
                download_btn: 'Descargar',
                gallery_title: 'P√≥sters creados',
                gallery_loading: 'Cargando p√≥sters...',
                gallery_empty: 'Ning√∫n p√≥ster creado',
                preview_title: 'Vista previa',
                preview_placeholder: 'Selecciona una direcci√≥n'
            },
            it: {
                search_title: 'Cerca indirizzo',
                search_placeholder: 'Inserisci citt√†, indirizzo o luogo...',
                settings_title: 'Impostazioni',
                city_label: 'Nome citt√†',
                city_placeholder: 'es. Roma',
                country_label: 'Paese',
                country_placeholder: 'es. Italia',
                radius_label: 'Raggio mappa',
                size_label: 'Dimensione poster',
                format_label: 'Formato output',
                format_png: 'PNG (Alta risoluzione, 300 DPI)',
                format_svg: 'SVG (Grafica vettoriale)',
                format_pdf: 'PDF (Pronto per la stampa)',
                buildings_label: 'Mostra edifici',
                buildings_desc: 'Contorni degli edifici sulla mappa',
                theme_title: 'Tema design',
                generate_btn: 'Crea poster',
                progress_title: 'Creazione in corso...',
                step_streets: 'Strade',
                step_water: 'Acqua',
                step_parks: 'Parchi',
                step_buildings: 'Edifici',
                step_render: 'Rendering',
                step_save: 'Salva',
                progress_starting: 'Avvio...',
                result_success: 'Poster creato con successo!',
                result_error: 'Si √® verificato un errore',
                download_btn: 'Scarica',
                gallery_title: 'Poster creati',
                gallery_loading: 'Caricamento poster...',
                gallery_empty: 'Nessun poster creato',
                preview_title: 'Anteprima',
                preview_placeholder: 'Seleziona un indirizzo'
            },
            pt: {
                search_title: 'Pesquisar endere√ßo',
                search_placeholder: 'Digite cidade, endere√ßo ou local...',
                settings_title: 'Configura√ß√µes',
                city_label: 'Nome da cidade',
                city_placeholder: 'ex. Lisboa',
                country_label: 'Pa√≠s',
                country_placeholder: 'ex. Portugal',
                radius_label: 'Raio do mapa',
                size_label: 'Tamanho do p√¥ster',
                format_label: 'Formato de sa√≠da',
                format_png: 'PNG (Alta resolu√ß√£o, 300 DPI)',
                format_svg: 'SVG (Gr√°fico vetorial)',
                format_pdf: 'PDF (Pronto para impress√£o)',
                buildings_label: 'Mostrar edif√≠cios',
                buildings_desc: 'Contornos de edif√≠cios no mapa',
                theme_title: 'Tema de design',
                generate_btn: 'Criar p√¥ster',
                progress_title: 'Criando...',
                step_streets: 'Ruas',
                step_water: '√Ågua',
                step_parks: 'Parques',
                step_buildings: 'Edif√≠cios',
                step_render: 'Renderizar',
                step_save: 'Salvar',
                progress_starting: 'Iniciando...',
                result_success: 'P√¥ster criado com sucesso!',
                result_error: 'Ocorreu um erro',
                download_btn: 'Baixar',
                gallery_title: 'P√¥sters criados',
                gallery_loading: 'Carregando p√¥sters...',
                gallery_empty: 'Nenhum p√¥ster criado',
                preview_title: 'Pr√©-visualiza√ß√£o',
                preview_placeholder: 'Selecione um endere√ßo'
            },
            nl: {
                search_title: 'Adres zoeken',
                search_placeholder: 'Voer stad, adres of plaats in...',
                settings_title: 'Instellingen',
                city_label: 'Stadsnaam',
                city_placeholder: 'bijv. Amsterdam',
                country_label: 'Land',
                country_placeholder: 'bijv. Nederland',
                radius_label: 'Kaartstraal',
                size_label: 'Postergrootte',
                format_label: 'Uitvoerformaat',
                format_png: 'PNG (Hoge resolutie, 300 DPI)',
                format_svg: 'SVG (Vectorafbeelding)',
                format_pdf: 'PDF (Drukklaar)',
                buildings_label: 'Gebouwen tonen',
                buildings_desc: 'Gebouwcontouren op de kaart',
                theme_title: 'Ontwerpthema',
                generate_btn: 'Poster maken',
                progress_title: 'Bezig met maken...',
                step_streets: 'Straten',
                step_water: 'Water',
                step_parks: 'Parken',
                step_buildings: 'Gebouwen',
                step_render: 'Renderen',
                step_save: 'Opslaan',
                progress_starting: 'Starten...',
                result_success: 'Poster succesvol gemaakt!',
                result_error: 'Er is een fout opgetreden',
                download_btn: 'Downloaden',
                gallery_title: 'Gemaakte posters',
                gallery_loading: 'Posters laden...',
                gallery_empty: 'Nog geen posters gemaakt',
                preview_title: 'Voorbeeld',
                preview_placeholder: 'Selecteer een adres'
            },
            pl: {
                search_title: 'Szukaj adresu',
                search_placeholder: 'Wpisz miasto, adres lub miejsce...',
                settings_title: 'Ustawienia',
                city_label: 'Nazwa miasta',
                city_placeholder: 'np. Warszawa',
                country_label: 'Kraj',
                country_placeholder: 'np. Polska',
                radius_label: 'Promie≈Ñ mapy',
                size_label: 'Rozmiar plakatu',
                format_label: 'Format wyj≈õciowy',
                format_png: 'PNG (Wysoka rozdzielczo≈õƒá, 300 DPI)',
                format_svg: 'SVG (Grafika wektorowa)',
                format_pdf: 'PDF (Gotowy do druku)',
                buildings_label: 'Poka≈º budynki',
                buildings_desc: 'Kontury budynk√≥w na mapie',
                theme_title: 'Motyw projektu',
                generate_btn: 'Utw√≥rz plakat',
                progress_title: 'Tworzenie...',
                step_streets: 'Ulice',
                step_water: 'Woda',
                step_parks: 'Parki',
                step_buildings: 'Budynki',
                step_render: 'Renderowanie',
                step_save: 'Zapisz',
                progress_starting: 'Uruchamianie...',
                result_success: 'Plakat utworzony pomy≈õlnie!',
                result_error: 'WystƒÖpi≈Ç b≈ÇƒÖd',
                download_btn: 'Pobierz',
                gallery_title: 'Utworzone plakaty',
                gallery_loading: '≈Åadowanie plakat√≥w...',
                gallery_empty: 'Brak utworzonych plakat√≥w',
                preview_title: 'PodglƒÖd',
                preview_placeholder: 'Wybierz adres'
            },
            ja: {
                search_title: '‰ΩèÊâÄ„ÇíÊ§úÁ¥¢',
                search_placeholder: 'ÈÉΩÂ∏Ç„ÄÅ‰ΩèÊâÄ„ÄÅÂ†¥ÊâÄ„ÇíÂÖ•Âäõ...',
                settings_title: 'Ë®≠ÂÆö',
                city_label: 'ÈÉΩÂ∏ÇÂêç',
                city_placeholder: '‰æãÔºöÊù±‰∫¨',
                country_label: 'ÂõΩ',
                country_placeholder: '‰æãÔºöÊó•Êú¨',
                radius_label: 'Âú∞Âõ≥„ÅÆÂçäÂæÑ',
                size_label: '„Éù„Çπ„Çø„Éº„Çµ„Ç§„Ç∫',
                format_label: 'Âá∫ÂäõÂΩ¢Âºè',
                format_png: 'PNGÔºàÈ´òËß£ÂÉèÂ∫¶„ÄÅ300 DPIÔºâ',
                format_svg: 'SVGÔºà„Éô„ÇØ„Çø„ÉºÁîªÂÉèÔºâ',
                format_pdf: 'PDFÔºàÂç∞Âà∑Áî®Ôºâ',
                buildings_label: 'Âª∫Áâ©„ÇíË°®Á§∫',
                buildings_desc: 'Âú∞Âõ≥‰∏ä„ÅÆÂª∫Áâ©„ÅÆËº™ÈÉ≠',
                theme_title: '„Éá„Ç∂„Ç§„É≥„ÉÜ„Éº„Éû',
                generate_btn: '„Éù„Çπ„Çø„Éº„Çí‰ΩúÊàê',
                progress_title: '‰ΩúÊàê‰∏≠...',
                step_streets: 'ÈÅìË∑Ø',
                step_water: 'Ê∞¥Âüü',
                step_parks: 'ÂÖ¨Âúí',
                step_buildings: 'Âª∫Áâ©',
                step_render: '„É¨„É≥„ÉÄ„É™„É≥„Ç∞',
                step_save: '‰øùÂ≠ò',
                progress_starting: 'ÈñãÂßã‰∏≠...',
                result_success: '„Éù„Çπ„Çø„Éº„ÅåÊ≠£Â∏∏„Å´‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
                result_error: '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
                download_btn: '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
                gallery_title: '‰ΩúÊàê„Åó„Åü„Éù„Çπ„Çø„Éº',
                gallery_loading: '„Éù„Çπ„Çø„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
                gallery_empty: '„Éù„Çπ„Çø„Éº„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì',
                preview_title: '„Éó„É¨„Éì„É•„Éº',
                preview_placeholder: '‰ΩèÊâÄ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'
            },
            zh: {
                search_title: 'ÊêúÁ¥¢Âú∞ÂùÄ',
                search_placeholder: 'ËæìÂÖ•ÂüéÂ∏Ç„ÄÅÂú∞ÂùÄÊàñÂú∞ÁÇπ...',
                settings_title: 'ËÆæÁΩÆ',
                city_label: 'ÂüéÂ∏ÇÂêçÁß∞',
                city_placeholder: '‰æãÂ¶ÇÔºöÂåó‰∫¨',
                country_label: 'ÂõΩÂÆ∂',
                country_placeholder: '‰æãÂ¶ÇÔºö‰∏≠ÂõΩ',
                radius_label: 'Âú∞ÂõæÂçäÂæÑ',
                size_label: 'Êµ∑Êä•Â∞∫ÂØ∏',
                format_label: 'ËæìÂá∫Ê†ºÂºè',
                format_png: 'PNGÔºàÈ´òÂàÜËæ®ÁéáÔºå300 DPIÔºâ',
                format_svg: 'SVGÔºàÁü¢ÈáèÂõæÔºâ',
                format_pdf: 'PDFÔºàÂèØÊâìÂç∞Ôºâ',
                buildings_label: 'ÊòæÁ§∫Âª∫Á≠ë',
                buildings_desc: 'Âú∞Âõæ‰∏äÁöÑÂª∫Á≠ëËΩÆÂªì',
                theme_title: 'ËÆæËÆ°‰∏ªÈ¢ò',
                generate_btn: 'ÂàõÂª∫Êµ∑Êä•',
                progress_title: 'ÂàõÂª∫‰∏≠...',
                step_streets: 'Ë°óÈÅì',
                step_water: 'Ê∞¥Âüü',
                step_parks: 'ÂÖ¨Âõ≠',
                step_buildings: 'Âª∫Á≠ë',
                step_render: 'Ê∏≤Êüì',
                step_save: '‰øùÂ≠ò',
                progress_starting: 'ÂêØÂä®‰∏≠...',
                result_success: 'Êµ∑Êä•ÂàõÂª∫ÊàêÂäüÔºÅ',
                result_error: 'ÂèëÁîüÈîôËØØ',
                download_btn: '‰∏ãËΩΩ',
                gallery_title: 'Â∑≤ÂàõÂª∫ÁöÑÊµ∑Êä•',
                gallery_loading: 'Ê≠£Âú®Âä†ËΩΩÊµ∑Êä•...',
                gallery_empty: 'Â∞öÊú™ÂàõÂª∫Êµ∑Êä•',
                preview_title: 'È¢ÑËßà',
                preview_placeholder: 'ËØ∑ÈÄâÊã©Âú∞ÂùÄ'
            },
            ko: {
                search_title: 'Ï£ºÏÜå Í≤ÄÏÉâ',
                search_placeholder: 'ÎèÑÏãú, Ï£ºÏÜå ÎòêÎäî Ïû•ÏÜå ÏûÖÎ†•...',
                settings_title: 'ÏÑ§Ï†ï',
                city_label: 'ÎèÑÏãú Ïù¥Î¶Ñ',
                city_placeholder: 'Ïòà: ÏÑúÏö∏',
                country_label: 'Íµ≠Í∞Ä',
                country_placeholder: 'Ïòà: ÎåÄÌïúÎØºÍµ≠',
                radius_label: 'ÏßÄÎèÑ Î∞òÍ≤Ω',
                size_label: 'Ìè¨Ïä§ÌÑ∞ ÌÅ¨Í∏∞',
                format_label: 'Ï∂úÎ†• ÌòïÏãù',
                format_png: 'PNG (Í≥†Ìï¥ÏÉÅÎèÑ, 300 DPI)',
                format_svg: 'SVG (Î≤°ÌÑ∞ Í∑∏ÎûòÌîΩ)',
                format_pdf: 'PDF (Ïù∏ÏáÑÏö©)',
                buildings_label: 'Í±¥Î¨º ÌëúÏãú',
                buildings_desc: 'ÏßÄÎèÑÏóê Í±¥Î¨º Ïú§Í≥ΩÏÑ†',
                theme_title: 'ÎîîÏûêÏù∏ ÌÖåÎßà',
                generate_btn: 'Ìè¨Ïä§ÌÑ∞ ÎßåÎì§Í∏∞',
                progress_title: 'ÏÉùÏÑ± Ï§ë...',
                step_streets: 'ÎèÑÎ°ú',
                step_water: 'ÏàòÏó≠',
                step_parks: 'Í≥µÏõê',
                step_buildings: 'Í±¥Î¨º',
                step_render: 'Î†åÎçîÎßÅ',
                step_save: 'Ï†ÄÏû•',
                progress_starting: 'ÏãúÏûë Ï§ë...',
                result_success: 'Ìè¨Ïä§ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!',
                result_error: 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§',
                download_btn: 'Îã§Ïö¥Î°úÎìú',
                gallery_title: 'ÏÉùÏÑ±Îêú Ìè¨Ïä§ÌÑ∞',
                gallery_loading: 'Ìè¨Ïä§ÌÑ∞ Î°úÎî© Ï§ë...',
                gallery_empty: 'ÏïÑÏßÅ ÏÉùÏÑ±Îêú Ìè¨Ïä§ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§',
                preview_title: 'ÎØ∏Î¶¨Î≥¥Í∏∞',
                preview_placeholder: 'Ï£ºÏÜåÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'
            },
            ru: {
                search_title: '–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞',
                search_placeholder: '–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å –∏–ª–∏ –º–µ—Å—Ç–æ...',
                settings_title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                city_label: '–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞',
                city_placeholder: '–Ω–∞–ø—Ä. –ú–æ—Å–∫–≤–∞',
                country_label: '–°—Ç—Ä–∞–Ω–∞',
                country_placeholder: '–Ω–∞–ø—Ä. –†–æ—Å—Å–∏—è',
                radius_label: '–†–∞–¥–∏—É—Å –∫–∞—Ä—Ç—ã',
                size_label: '–†–∞–∑–º–µ—Ä –ø–æ—Å—Ç–µ—Ä–∞',
                format_label: '–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞',
                format_png: 'PNG (–í—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, 300 DPI)',
                format_svg: 'SVG (–í–µ–∫—Ç–æ—Ä–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞)',
                format_pdf: 'PDF (–ì–æ—Ç–æ–≤ –∫ –ø–µ—á–∞—Ç–∏)',
                buildings_label: '–ü–æ–∫–∞–∑–∞—Ç—å –∑–¥–∞–Ω–∏—è',
                buildings_desc: '–ö–æ–Ω—Ç—É—Ä—ã –∑–¥–∞–Ω–∏–π –Ω–∞ –∫–∞—Ä—Ç–µ',
                theme_title: '–¢–µ–º–∞ –¥–∏–∑–∞–π–Ω–∞',
                generate_btn: '–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–µ—Ä',
                progress_title: '–°–æ–∑–¥–∞–Ω–∏–µ...',
                step_streets: '–£–ª–∏—Ü—ã',
                step_water: '–í–æ–¥–∞',
                step_parks: '–ü–∞—Ä–∫–∏',
                step_buildings: '–ó–¥–∞–Ω–∏—è',
                step_render: '–†–µ–Ω–¥–µ—Ä–∏–Ω–≥',
                step_save: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ',
                progress_starting: '–ó–∞–ø—É—Å–∫...',
                result_success: '–ü–æ—Å—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!',
                result_error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞',
                download_btn: '–°–∫–∞—á–∞—Ç—å',
                gallery_title: '–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–µ—Ä—ã',
                gallery_loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–µ—Ä–æ–≤...',
                gallery_empty: '–ü–æ—Å—Ç–µ—Ä—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã',
                preview_title: '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä',
                preview_placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'de';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            const t = translations[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            
            const option = document.querySelector(`.lang-option[data-lang="${lang}"]`);
            if (option) {
                document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                document.getElementById('currentFlag').textContent = option.dataset.flag;
                document.getElementById('currentLang').textContent = option.querySelector('span:last-child').textContent;
            }
        }

        document.querySelectorAll('.lang-option').forEach(option => {
            option.addEventListener('click', () => {
                setLanguage(option.dataset.lang);
            });
        });

        setLanguage(currentLang);

        const langBtn = document.getElementById('langBtn');
        const langDropdown = document.getElementById('langDropdown');
        if (langBtn && langDropdown) {
            ['mouseenter', 'focus'].forEach(evt => {
                langBtn.addEventListener(evt, () => langBtn.setAttribute('aria-expanded', 'true'));
            });
            ['mouseleave', 'blur'].forEach(evt => {
                langBtn.addEventListener(evt, () => langBtn.setAttribute('aria-expanded', 'false'));
            });
        }

        // ==================== Theme Toggle ====================
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        setTheme(localStorage.getItem('theme') || 'light');

        // ==================== App State ====================
        let selectedLocation = null;
        let selectedTheme = 'feature_based';
        let currentJobId = null;
        let eventSource = null;
        let eventSourceRetries = 0;
        const MAX_EVENTSOURCE_RETRIES = 2;
        const COLOR_PATTERN = /^(#[0-9a-fA-F]{3,8}|rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)|rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*(0|1|0?\.\d+)\s*\))$/;

        function sanitizeColor(value, fallback) {
            if (typeof value === 'string' && COLOR_PATTERN.test(value.trim())) {
                return value.trim();
            }
            return fallback;
        }

        // ==================== Search ====================
        const searchInput = document.getElementById('searchInput');
        const searchLoader = document.getElementById('searchLoader');
        const searchResults = document.getElementById('searchResults');
        const selectedLocationDiv = document.getElementById('selectedLocation');
        const generateBtn = document.getElementById('generateBtn');

        let searchTimeout = null;
        let searchHighlightIndex = -1;

        function renderSearchResults(results) {
            searchResults.innerHTML = '';
            searchHighlightIndex = -1;

            if (!results || results.length === 0) {
                const item = document.createElement('div');
                item.classList.add('search-result-item');
                item.setAttribute('role', 'option');
                const main = document.createElement('div');
                main.classList.add('search-result-main');
                main.textContent = 'No results';
                item.appendChild(main);
                searchResults.appendChild(item);
                searchResults.classList.add('active');
                searchInput.setAttribute('aria-expanded', 'true');
                return;
            }

            results.forEach((r) => {
                const item = document.createElement('div');
                item.classList.add('search-result-item');
                item.setAttribute('role', 'option');
                item.tabIndex = -1;
                item.dataset.lat = r.lat != null ? String(r.lat) : '';
                item.dataset.lon = r.lon != null ? String(r.lon) : '';
                item.dataset.city = r.city || '';
                item.dataset.country = r.country || '';
                item.dataset.address = r.display_name || '';

                const main = document.createElement('div');
                main.classList.add('search-result-main');
                main.textContent = r.city || (r.display_name ? r.display_name.split(',')[0] : '');

                const sub = document.createElement('div');
                sub.classList.add('search-result-sub');
                sub.textContent = r.display_name || '';

                item.appendChild(main);
                item.appendChild(sub);
                searchResults.appendChild(item);
            });

            searchResults.classList.add('active');
            searchInput.setAttribute('aria-expanded', 'true');
        }

        function highlightResult(index) {
            const items = Array.from(searchResults.querySelectorAll('.search-result-item'));
            items.forEach(el => {
                el.classList.remove('focused');
                el.setAttribute('aria-selected', 'false');
            });
            if (index >= 0 && items[index]) {
                items[index].classList.add('focused');
                items[index].setAttribute('aria-selected', 'true');
                items[index].focus();
                searchHighlightIndex = index;
            } else {
                searchHighlightIndex = -1;
            }
        }

        function selectSearchResult(item) {
            if (!item || !item.dataset.lat) return;

            selectedLocation = {
                lat: parseFloat(item.dataset.lat),
                lon: parseFloat(item.dataset.lon),
                city: item.dataset.city,
                country: item.dataset.country,
                address: item.dataset.address
            };

            document.getElementById('selectedCity').textContent = selectedLocation.city || selectedLocation.address.split(',')[0];
            document.getElementById('selectedAddress').textContent = selectedLocation.address;
            document.getElementById('selectedCoords').textContent = `${selectedLocation.lat.toFixed(4)}¬∞ / ${selectedLocation.lon.toFixed(4)}¬∞`;
            selectedLocationDiv.classList.add('active');

            document.getElementById('cityName').value = selectedLocation.city || selectedLocation.address.split(',')[0];
            document.getElementById('countryName').value = selectedLocation.country || '';

            updatePreview();
            generateBtn.disabled = false;
            searchResults.classList.remove('active');
            searchInput.setAttribute('aria-expanded', 'false');
            searchInput.value = selectedLocation.city || selectedLocation.address.split(',')[0];
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 3) {
                searchResults.classList.remove('active');
                searchInput.setAttribute('aria-expanded', 'false');
                return;
            }
            
            searchLoader.classList.add('active');
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    renderSearchResults(Array.isArray(results) ? results : []);
                } catch (error) {
                    console.error('Search error:', error);
                } finally {
                    searchLoader.classList.remove('active');
                }
            }, 300);
        });

        searchInput.addEventListener('keydown', (e) => {
            const items = Array.from(searchResults.querySelectorAll('.search-result-item'));
            if (e.key === 'ArrowDown') {
                if (!searchResults.classList.contains('active')) return;
                e.preventDefault();
                const nextIndex = Math.min(searchHighlightIndex + 1, items.length - 1);
                highlightResult(nextIndex);
            } else if (e.key === 'ArrowUp') {
                if (!searchResults.classList.contains('active')) return;
                e.preventDefault();
                const prevIndex = Math.max(searchHighlightIndex - 1, 0);
                highlightResult(prevIndex);
            } else if (e.key === 'Enter' && searchHighlightIndex >= 0) {
                e.preventDefault();
                selectSearchResult(items[searchHighlightIndex]);
            } else if (e.key === 'Escape') {
                searchResults.classList.remove('active');
                searchInput.setAttribute('aria-expanded', 'false');
            }
        });

        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            selectSearchResult(item);
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('active');
                searchInput.setAttribute('aria-expanded', 'false');
            }
        });

        // ==================== Theme Selection ====================
        const themeGrid = document.getElementById('themeGrid');

        function selectThemeItem(item) {
            if (!item) return;
            document.querySelectorAll('.theme-item').forEach(el => {
                el.classList.remove('selected');
                el.setAttribute('aria-pressed', 'false');
            });
            item.classList.add('selected');
            item.setAttribute('aria-pressed', 'true');
            selectedTheme = item.dataset.theme;
            updatePreview();
        }

        if (themeGrid) {
            themeGrid.querySelectorAll('.theme-item').forEach(item => {
                if (!item.hasAttribute('tabindex')) {
                    item.setAttribute('tabindex', '0');
                }
                if (!item.hasAttribute('role')) {
                    item.setAttribute('role', 'button');
                }
                item.setAttribute(
                    'aria-pressed',
                    item.classList.contains('selected') ? 'true' : 'false'
                );
            });

            themeGrid.addEventListener('click', (e) => {
                const item = e.target.closest('.theme-item');
                if (!item) return;
                selectThemeItem(item);
            });

            themeGrid.addEventListener('keydown', (e) => {
                const item = e.target.closest('.theme-item');
                if (!item) return;
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectThemeItem(item);
                }
            });
        }

        // ==================== Preview ====================
        function updatePreview() {
            if (!selectedLocation) return;
            
            const themeItem = document.querySelector(`.theme-item[data-theme="${selectedTheme}"]`);
            const bgColor = sanitizeColor(themeItem?.dataset.bg || '', '#ffffff');
            const textColor = sanitizeColor(themeItem?.dataset.text || '', '#000000');
            
            const cityName = document.getElementById('cityName').value || selectedLocation.city || 'CITY';
            const countryName = document.getElementById('countryName').value || selectedLocation.country || '';
            
            const spacedCity = cityName.toUpperCase().split('').join(' ');
            
            const lat = selectedLocation.lat;
            const lon = selectedLocation.lon;
            const coords = `${Math.abs(lat).toFixed(4)}¬∞ ${lat >= 0 ? 'N' : 'S'} / ${Math.abs(lon).toFixed(4)}¬∞ ${lon >= 0 ? 'E' : 'W'}`;
            
            const previewContainer = document.getElementById('previewContainer');
            const previewPoster = document.getElementById('previewPoster');
            
            previewContainer.style.background = bgColor;
            previewPoster.style.color = textColor;
            document.querySelector('.preview-gradient-top').style.background = `linear-gradient(to bottom, ${bgColor}, transparent)`;
            document.querySelector('.preview-gradient-bottom').style.background = `linear-gradient(to top, ${bgColor}, transparent)`;
            
            document.getElementById('previewCity').textContent = spacedCity;
            document.getElementById('previewCountry').textContent = countryName.toUpperCase();
            document.getElementById('previewCoords').textContent = coords;
            
            document.getElementById('previewPlaceholder').style.display = 'none';
            previewPoster.classList.add('active');
        }

        ['cityName', 'countryName'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        // ==================== Radius Slider ====================
        const distanceSlider = document.getElementById('distance');
        const distanceValue = document.getElementById('distanceValue');

        distanceSlider.addEventListener('input', () => {
            const value = parseInt(distanceSlider.value);
            if (value >= 1000) {
                distanceValue.textContent = (value / 1000) + ' km';
            } else {
                distanceValue.textContent = value + ' m';
            }
        });

        // ==================== Buildings Toggle Accessibility ====================
        const buildingsToggle = document.getElementById('buildingsToggle');
        const buildingsCheckbox = document.getElementById('includeBuildings');

        function syncBuildingsAria() {
            if (!buildingsToggle) return;
            const checked = buildingsCheckbox.checked;
            buildingsToggle.setAttribute('aria-pressed', checked ? 'true' : 'false');
            buildingsToggle.setAttribute('aria-checked', checked ? 'true' : 'false');
        }

        function toggleBuildings() {
            buildingsCheckbox.checked = !buildingsCheckbox.checked;
            syncBuildingsAria();
        }

        if (buildingsToggle) {
            buildingsToggle.addEventListener('click', (e) => {
                if (e.target.closest('input')) return;
                toggleBuildings();
            });

            buildingsToggle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleBuildings();
                }
            });

            buildingsCheckbox.addEventListener('change', syncBuildingsAria);
            syncBuildingsAria();
        }

        // ==================== Generate ====================
        generateBtn.addEventListener('click', async () => {
            if (!selectedLocation) return;
            
            const params = {
                city: document.getElementById('cityName').value || selectedLocation.city,
                country: document.getElementById('countryName').value || selectedLocation.country,
                lat: selectedLocation.lat,
                lon: selectedLocation.lon,
                distance: parseInt(document.getElementById('distance').value) || 10000,
                theme: selectedTheme,
                format: document.getElementById('outputFormat').value,
                size: document.getElementById('posterSize').value,
                buildings: document.getElementById('includeBuildings').checked
            };
            
            generateBtn.disabled = true;
            document.getElementById('progressCard').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
            document.querySelectorAll('.progress-step').forEach(el => {
                el.classList.remove('active', 'completed');
            });
            document.getElementById('progressBar').style.width = '0%';
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                currentJobId = data.job_id;
                eventSourceRetries = 0;

                const attachEventSource = (jobId) => {
                    if (eventSource) eventSource.close();
                    eventSource = new EventSource(`/api/progress/${jobId}`);

                    eventSource.onmessage = (event) => {
                        const update = JSON.parse(event.data);
                        
                        if (update.keepalive) return;
                        
                        if (update.step === 'error') {
                            showError(update.message);
                            eventSource.close();
                            return;
                        }
                        
                        if (update.step === 'complete') {
                            showSuccess(update.filename, update.download_url);
                            eventSource.close();
                            // Don't reload gallery - new posters are temp only
                            return;
                        }
                        
                        document.getElementById('progressBar').style.width = `${update.progress}%`;
                        document.getElementById('progressMessage').textContent = update.message;
                        
                        const stepEl = document.querySelector(`.progress-step[data-step="${update.step}"]`);
                        if (stepEl) {
                            document.querySelectorAll('.progress-step').forEach(el => {
                                if (el !== stepEl && !el.classList.contains('completed')) {
                                    const stepOrder = ['fetch_streets', 'fetch_water', 'fetch_parks', 'fetch_buildings', 'render', 'save'];
                                    const currentIdx = stepOrder.indexOf(update.step);
                                    const elIdx = stepOrder.indexOf(el.dataset.step);
                                    if (elIdx < currentIdx) {
                                        el.classList.remove('active');
                                        el.classList.add('completed');
                                    }
                                }
                            });
                            stepEl.classList.add('active');
                        }
                    };

                    eventSource.onerror = () => {
                        eventSource.close();
                        if (eventSourceRetries < MAX_EVENTSOURCE_RETRIES) {
                            eventSourceRetries += 1;
                            setTimeout(() => attachEventSource(jobId), 1000 * eventSourceRetries);
                            return;
                        }
                        if (typeof navigator !== 'undefined' && navigator && navigator.onLine === false) {
                            showError('Your internet connection was lost while generating the poster. Please check your connection and try again.');
                        } else {
                            showError('The connection to the server was interrupted while generating the poster. Please try again. If the problem persists, the poster may still finish in the background.');
                        }
                    };
                };

                attachEventSource(currentJobId);
                
            } catch (error) {
                showError(error.message);
            }
        });

        function showError(message) {
            document.getElementById('progressCard').classList.remove('active');
            document.getElementById('resultCard').classList.add('active');
            document.getElementById('resultSuccess').style.display = 'none';
            document.getElementById('resultError').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            generateBtn.disabled = false;
        }

        function showSuccess(filename, downloadUrl) {
            document.getElementById('progressCard').classList.remove('active');
            document.getElementById('resultCard').classList.add('active');
            document.getElementById('resultSuccess').style.display = 'block';
            document.getElementById('resultError').style.display = 'none';
            document.getElementById('resultFilename').textContent = filename;
            document.getElementById('downloadBtn').href = downloadUrl;
            generateBtn.disabled = false;
        }

        // ==================== Gallery ====================
        async function loadGallery() {
            try {
                const response = await fetch('/api/posters');
                const posters = await response.json();
                
                const galleryGrid = document.getElementById('galleryGrid');
                const t = translations[currentLang];
                
                if (posters.length === 0) {
                    galleryGrid.innerHTML = `<div class="gallery-empty">${t.gallery_empty}</div>`;
                    return;
                }
                
                galleryGrid.innerHTML = '';
                const fragment = document.createDocumentFragment();

                posters.slice(0, 20).forEach(p => {
                    const ext = p.filename.split('.').pop().toUpperCase();
                    const size = (p.size / 1024 / 1024).toFixed(1);
                    const nameParts = p.filename.replace(/\.[^.]+$/, '').split('_');
                    const name = nameParts[0] || 'Poster';
                    const theme = nameParts[1] ? nameParts[1].replace(/-/g, ' ') : '';

                    const themeName = theme.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

                    const item = document.createElement('div');
                    item.classList.add('gallery-item');

                    let previewEl;
                    if (ext === 'PDF') {
                        previewEl = document.createElement('div');
                        previewEl.classList.add('gallery-preview-pdf');
                        const icon = document.createElement('i');
                        icon.classList.add('fas', 'fa-file-pdf');
                        const label = document.createElement('span');
                        label.textContent = 'PDF';
                        previewEl.appendChild(icon);
                        previewEl.appendChild(label);
                    } else {
                        previewEl = document.createElement('img');
                        previewEl.classList.add('gallery-preview');
                        previewEl.setAttribute('loading', 'lazy');
                        previewEl.src = p.preview_url;
                        previewEl.alt = name;
                    }

                    const info = document.createElement('div');
                    info.classList.add('gallery-info');

                    const titleEl = document.createElement('div');
                    titleEl.classList.add('gallery-name');
                    titleEl.textContent = name;
                    titleEl.title = p.filename;
                    info.appendChild(titleEl);

                    if (themeName) {
                        const themeEl = document.createElement('div');
                        themeEl.classList.add('gallery-theme');
                        const paletteIcon = document.createElement('i');
                        paletteIcon.classList.add('fas', 'fa-palette');
                        themeEl.appendChild(paletteIcon);
                        const themeText = document.createTextNode(` ${themeName}`);
                        themeEl.appendChild(themeText);
                        info.appendChild(themeEl);
                    }

                    const meta = document.createElement('div');
                    meta.classList.add('gallery-meta');

                    const sizeEl = document.createElement('span');
                    sizeEl.textContent = `${size} MB`;
                    const formatEl = document.createElement('span');
                    formatEl.classList.add('gallery-format');
                    formatEl.textContent = ext;
                    meta.appendChild(sizeEl);
                    meta.appendChild(formatEl);

                    info.appendChild(meta);

                    const download = document.createElement('a');
                    download.href = p.download_url;
                    download.classList.add('gallery-download');
                    const dlIcon = document.createElement('i');
                    dlIcon.classList.add('fas', 'fa-download');
                    const dlText = document.createTextNode(` ${t.download_btn}`);
                    download.appendChild(dlIcon);
                    download.appendChild(dlText);

                    item.appendChild(previewEl);
                    item.appendChild(info);
                    item.appendChild(download);

                    fragment.appendChild(item);
                });

                galleryGrid.appendChild(fragment);
                
            } catch (error) {
                console.error('Gallery error:', error);
            }
        }

        loadGallery();
    </script>
</body>
</html>
